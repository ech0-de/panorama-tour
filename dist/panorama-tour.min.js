!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).panoramaTour=t()}(this,(function(){"use strict";return async function(e,t){e.classList.add("pt-container"),localStorage.getItem("scene")&&t.scenes[localStorage.getItem("scene")]||localStorage.setItem("scene",t.default.firstScene),t.default.firstScene=localStorage.getItem("scene")||t.default.firstScene,window.innerWidth>1200?t.default.hfov=120:window.innerWidth>768?t.default.hfov=100:window.innerWidth>576?t.default.hfov=80:t.default.hfov=50;const n=await new Promise((e=>{if(!0===t.debug){const n=indexedDB.open("db",1);n.onupgradeneeded=e=>{e.currentTarget.result.createObjectStore("store",{keyPath:"id",autoIncrement:!0}).createIndex("title","title",{unique:!0})},n.onsuccess=()=>{const o=n.result,s=o.transaction("store","readonly").objectStore("store");s.openCursor().onsuccess=n=>{const a=n.target.result;a?(s.get(a.key).onsuccess=e=>{const n=e.target.result;if(n)try{n.panorama=URL.createObjectURL(n.blob),t.scenes[n.file||n.title]=n}catch{console.error("could not restore scene",n.file||n.title)}},a.continue()):e(o)}}}else e(null)}));let o=t.default.firstScene,s=null;const a=window.pannellum.viewer(e,t),i={pitch:0,yaw:0,hfov:0},c=()=>{i.pitch=a.getPitch(),i.yaw=a.getYaw(),i.hfov=a.getHfov()};c();const r=()=>{a.loadScene(o);const e=document.querySelector("button.active");e&&e.click()};if(a.on("mouseup",c),a.on("touchend",c),a.on("load",(()=>{let e=0;if(null!==o)e=t.scenes[o].northOffset;else{if(!a.getScene())return;e=2*t.scenes[a.getScene()].northOffset}if(o=a.getScene(),e-=t.scenes[o].northOffset,t.scenes[o].level!==s){const e=document.querySelector(`.pt-levels button[data-level="${t.scenes[o].level}"]`);e&&e.click()}a.lookAt(i.pitch,i.yaw+e,i.hfov,!1),localStorage.setItem("scene",o),c()})),"object"==typeof L){const i=document.createElement("div");i.classList.add("pt-minimap"),e.querySelector(".pnlm-ui").append(i);const c=L.map(i,t.map),l=document.createElement("div");l.classList.add("pt-levels"),e.querySelector(".pnlm-ui").append(l);const d=L.layerGroup();d.addTo(c);const p=document.createElement("div");p.classList.add("pt-minimap-btn"),p.innerHTML="🗺️",p.addEventListener("click",(()=>{l.classList.toggle("is-visible"),i.classList.toggle("is-visible"),c.invalidateSize()})),e.querySelector(".pnlm-ui").append(p);const m=L.divIcon({html:"📷️",iconSize:[20,20],className:"pt-minimap-inactive"}),u=L.divIcon({html:"👁️",iconSize:[20,20],className:"pt-minimap-active"}),f=L.divIcon({html:"🔗️",iconSize:[20,20],className:"pt-minimap-active"});if(Array.isArray(t.map.elements)){const e={},n=[],o=new Map,a=new Set;for(const o of t.map.elements)"node"===o.type?e[o.id]=o:"way"===o.type&&n.push(o);for(const t of n){if(!t.tags.hasOwnProperty("indoor:level")&&!t.tags.hasOwnProperty("building"))continue;const n=L.polygon(t.nodes.map((t=>[e[t].lat,e[t].lon])),{color:"white"});/.*[^0-9\-].*/.test(t.tags["indoor:level"])?a.add(n):(o.has(t.tags["indoor:level"])||o.set(t.tags["indoor:level"],[]),o.get(t.tags["indoor:level"]).push(n))}[...o.keys()].sort(((e,t)=>Number(t)-Number(e))).forEach((e=>{const n=document.createElement("button");n.dataset.level=e,n.innerText=e,n.onclick=()=>{const i=document.querySelector(".pt-levels button.active");i&&i.classList.remove("active"),n.classList.add("active"),s=e,d.clearLayers(),[...a,...o.get(e),...Object.values(t.scenes).filter((t=>!t.level||t.level===e)).map((e=>e.marker))].forEach((e=>e&&d.addLayer(e)))},l.appendChild(n)}))}if(Array.isArray(t.map.polygons))for(const e of t.map.polygons)L.polygon(e,{color:"red"}).addTo(c);const v=()=>new Promise((e=>{i.classList.add("pt-debug"),setTimeout((()=>{c.invalidateSize(),c.setMaxZoom(t.map.zoom+1),c.setZoom(t.map.zoom+1),e()}))})),g=()=>new Promise((e=>{i.classList.remove("pt-debug"),setTimeout((()=>{c.invalidateSize(),c.setZoom(t.map.zoom),c.setMaxZoom(t.map.maxZoom),e()}),1e3)})),b=(e,n)=>{if(!t.scenes[n])return void console.error("undefined scene",n);const o=-180*Math.atan2(e.lat-t.scenes[n].lat,e.lon-t.scenes[n].lon)/Math.PI-e.northOffset;e.hotSpots.push({pitch:-15,yaw:o,type:"scene",text:t.scenes[n].title,sceneId:n,sceneFadeDuration:800})},h=(e,i)=>{i.title=i.title||e,Array.isArray(i.relations)&&(i.hotSpots=[],i.relations.forEach((e=>b(i,e)))),i.marker=L.marker([i.lat,i.lon],{icon:m}).on("click",(()=>a.loadScene(e))).on("contextmenu",(async()=>{t.debug&&(e!==o?t.scenes[o].relations.includes(e)?(t.scenes[e].marker.setIcon(m),t.scenes[o].relations.splice(t.scenes[o].relations.indexOf(e),1),t.scenes[o].hotSpots.splice(t.scenes[o].hotSpots.findIndex((t=>t.sceneId===e)),1)):(t.scenes[e].marker.setIcon(f),t.scenes[o].relations.push(e),b(t.scenes[o],e)):(await v(),await new Promise((n=>c.once("click",(o=>{t.scenes[e].lat=o.latlng.lat,t.scenes[e].lon=o.latlng.lng,t.scenes[e].level=s,t.scenes[e].marker.setLatLng(o.latlng),t.scenes[e].hotSpots=[],t.scenes[e].relations.forEach((e=>b(i,e))),g(),n()}))))),n.transaction("store","readwrite").objectStore("store").put({...t.scenes[o],hotSpots:void 0,marker:void 0}).onsuccess=()=>r())}))};if(Object.entries(t.scenes).forEach((([e,t])=>h(e,t))),a.on("load",(e=>{o&&(Object.values(t.scenes).forEach((e=>e&&e.marker.setIcon(m))),t.scenes[o].marker.setIcon(u),!0===t.debug&&t.scenes[o].relations.forEach((e=>{t.scenes[e].marker.setIcon(f)})))})),!0===t.debug&&n){document.addEventListener("dragover",(e=>e.preventDefault())),document.addEventListener("drop",(async e=>{e.preventDefault();const o=new Set([...[...e.dataTransfer.items].map((e=>e.getAsFile())),...e.dataTransfer.files]);await v();const a=document.createElement("img");a.style.position="fixed",a.style.top=0,a.style.left="50%",a.style.width="30vw",a.style.marginLeft="-15vw",a.style.zIndex=999,document.body.appendChild(a);for(const e of o){const o=URL.createObjectURL(e);a.src=o,t.scenes[e.name]||await new Promise((a=>c.once("click",(i=>{const c={blob:e,file:e.name,title:e.name,description:"",level:s,lat:i.latlng.lat,lon:i.latlng.lng,northOffset:0,panorama:o,relations:[]};n.transaction("store","readwrite").objectStore("store").add(c).onsuccess=()=>{t.scenes[e.name]=c,h(e.name,c),a()}}))))}a.remove(),await g()}));const a=document.createElement("div");a.classList.add("pt-minimap-btn"),a.style.marginBottom="54px",a.innerHTML="📁",a.addEventListener("click",(()=>{const e={default:t.default,map:t.map,scenes:Object.fromEntries(Object.entries(t.scenes).map((([e,t])=>[e,{...t,panorama:t.file||t.title,hotSpots:void 0,marker:void 0,blob:void 0}])))};console.log(e),console.log(JSON.stringify(e))})),e.querySelector(".pnlm-ui").append(a);const i=document.createElement("div");i.classList.add("pt-minimap-btn"),i.style.marginBottom="108px",i.innerHTML="🗑️",i.addEventListener("click",(async()=>{for(const e of Object.keys(t.scenes).filter((e=>t.scenes[e].relations.includes(o))))t.scenes[e].relations=t.scenes[e].relations.filter((e=>e!==o)),await new Promise((o=>n.transaction("store","readwrite").objectStore("store").put({...t.scenes[e],hotSpots:void 0,marker:void 0}).addEventListener("success",o)));await new Promise((e=>n.transaction("store","readwrite").objectStore("store").delete(t.scenes[o].id).addEventListener("success",e))),c.removeLayer(t.scenes[o].marker),delete t.scenes[o],r()})),e.querySelector(".pnlm-ui").append(i);const l=document.createElement("div");l.classList.add("pt-minimap-btn"),l.style.marginBottom="162px",l.innerHTML="🏷️",l.addEventListener("click",(async()=>{const e=prompt(`New title for ${o}?`,t.scenes[o].title);e&&(t.scenes[o].file||(t.scenes[o].file=t.scenes[o].title),t.scenes[o].title=e,await new Promise((e=>n.transaction("store","readwrite").objectStore("store").put({...t.scenes[o],hotSpots:void 0,marker:void 0}).addEventListener("success",e))),r())})),e.querySelector(".pnlm-ui").append(l)}setTimeout((()=>{p.click();const e=document.querySelector(".pt-levels button");e&&e.click(),r()}),100)}const l=document.createElement("style");l.innerText=".pnlm-compass,.pt-minimap-btn{box-shadow:0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12),0 3px 1px -2px rgba(0,0,0,.2)}.pnlm-compass{background-color:rgba(255,255,255,.5)}.pt-minimap-btn{background-color:#fff;width:50px;height:50px;text-align:center;border-radius:50%;cursor:pointer;opacity:.6;transition:.5s;border:1px solid #999;border-color:rgba(0,0,0,.4);display:grid;align-items:center;justify-content:center;position:absolute;right:4px;bottom:58px}.pt-minimap-btn:hover{opacity:1}.pt-levels,.pt-minimap{position:absolute!important;top:0;left:0;display:none;transition:.5s}.pt-minimap{right:0;width:100vw;height:100vw;background-color:rgba(0,0,0,.8);z-index:9999}.pt-levels{z-index:10000}.pt-levels button{width:32px;height:32px;text-align:center;background-color:#333;border:2px solid #999;display:block;margin:5px;padding:0;color:#fff;font-weight:700;opacity:.3}.pt-levels button.active{opacity:.6}.pt-levels button:hover{opacity:.8}.pt-debug{cursor:pointer!important;transition:0ms!important}.pt-levels.is-visible,.pt-minimap.is-visible{display:block}@media (min-width:768px){.pt-minimap:not(.pt-debug){top:auto;right:auto;left:0;bottom:0;width:400px;height:250px;opacity:.2;background-color:rgba(0,0,0,.3);transition:.5s}.pt-levels:not(.pt-debug){top:calc(100vh - 250px);transition:.5s}.pt-minimap:hover{background-color:rgba(0,0,0,.6);opacity:1}}.pt-minimap-inactive{color:#888;font-size:14pt}.pt-minimap-active{color:#fff;font-size:14pt}",l.type="text/css",document.head.appendChild(l)}}));
